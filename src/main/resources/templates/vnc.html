<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>OpenCluster - Consola VNC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .info-bar {
            background: linear-gradient(to right, #f8f9fa, #ffffff);
            padding: 1.25rem;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .vm-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .vm-id {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .vnc-container {
            flex-grow: 1;
            position: relative;
            height: calc(100vh - 80px);
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .info-value {
            color: #2c3e50;
            font-weight: 500;
        }
        .vm-status {
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-section {
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: 100%;
        }
        .status-running { background-color: #fb8c00; color: white; }
        .status-stopped { background-color: #F44335; color: white; }
        .card {
            transition: transform 0.3s cubic-bezier(0.34, 1.61, 0.7, 1),
            box-shadow 0.3s cubic-bezier(0.34, 1.61, 0.7, 1);
        }
        .card:hover{
            transform: translateY(-5.5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .uwu{
            transition: transform 0.3s cubic-bezier(0.34, 1.61, 0.7, 1);
        }
        .uwu:hover{
            transform: translateY(-5.5px);
        }
    </style>
</head>
<body>
    <div class="info-bar">
        <div class="container-fluid">
            <div class="row align-items-center mb-3">
                <div class="col">
                    <h5 class="mb-0 d-flex align-items-center vm-title">
                        <i class="uwu fas fa-laptop me-2"></i>
                        <span class="uwu" id="vmName">Cargando...</span>
                        <span class="vm-id me-4" id="vmId">#000</span>
                        <span class="vm-status ms-3 uwu" id="vmStatus">
                            <span>----</span>
                        </span>
                    </h5>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-secondary uwu" onclick="window.close()">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="info-section card">
                        <div class="info-label">
                            <i class="fas fa-layer-group"></i>
                            Slice
                        </div>
                        <div class="info-value" id="sliceName">Cargando...</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-section card">
                        <div class="info-label">
                            <i class="fas fa-microchip"></i>
                            Flavor
                        </div>
                        <div class="info-value" id="flavorInfo">Cargando...</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-section card">
                        <div class="info-label">
                            <i class="fas fa-hdd"></i>
                            Imagen
                        </div>
                        <div class="info-value" id="imageInfo">Cargando...</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-section card">
                        <div class="info-label">
                            <i class="fas fa-server"></i>
                            Servidor físico
                        </div>
                        <div class="info-value" id="workerInfo">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="vnc-container">
        <iframe th:src="@{'/novnc/vnc.html?path=User/api/vnc/vm/' + ${vmId} + '/socket?token=' + ${token}}" allowfullscreen></iframe>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:inline="javascript">
        const vmId = /*[[${vmId}]]*/ '';
        const token = /*[[${token}]]*/ '';

        async function loadVMInfo() {
            try {
                const response = await fetch(`/User/api/slice/vm/${vmId}`);
                const data = await response.json();

                console.log('VM Info: ', data);
                
                if (data.content && data.content.vm_info) {
                    // VM Name, ID and Status
                    document.getElementById('vmName').textContent = data.content.vm_info.name;
                    document.getElementById('vmId').textContent = `#${data.content.vm_info.id}`;
                    const statusElement = document.getElementById('vmStatus');
                    const isRunning = data.content.vm_info.status === 'running';
                    statusElement.innerHTML = `
                        <span>${isRunning ? 'En Ejecución' : 'Detenido'}</span>
                    `;
                    statusElement.className = `uwu vm-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                    
                    // Slice info
                    document.getElementById('sliceName').textContent = data.content.slice?.name || '----';
                    
                    // Resources info (Flavor)
                    document.getElementById('flavorInfo').textContent = 
                        data.content.resources?.flavor ? 
                        `${data.content.resources.flavor.name} (${data.content.resources.flavor.vcpus} vCPUs, ${data.content.resources.flavor.ram/1024}GB RAM, ${data.content.resources.flavor.disk}GB Disco)` : 
                        '----';
                    
                    // Image info
                    document.getElementById('imageInfo').textContent = data.content.resources?.image?.name || '----';
                    
                    // Worker info
                    document.getElementById('workerInfo').textContent = data.content.worker?.name || '----';
                } else {
                    console.warn('No VM info found in response:', data);
                    setDefaultValues();
                }
            } catch (error) {
                console.error('Error loading VM info:', error);
                setDefaultValues();
            }
        }

        function setDefaultValues() {
            document.getElementById('vmName').textContent = '----';
            const statusElement = document.getElementById('vmStatus');
            statusElement.textContent = '';
            statusElement.className = 'vm-status uwu';
            document.getElementById('sliceName').textContent = '----';
            document.getElementById('flavorInfo').textContent = '----';
            document.getElementById('imageInfo').textContent = '----';
            document.getElementById('workerInfo').textContent = '----';
        }

        document.addEventListener('DOMContentLoaded', loadVMInfo);
    </script>
</body>
</html>